# **怎么分析设计高并发红包雨系统？**

这个问题在一个月前的Lazada面试中遇到过，但是当时胡说八道了一通，也没说到点上，今天逛B站时，发现尚硅谷前两天刚发布了“红包雨系统架构设计”的直播课，课程质量很高，也让我一个月前没理清的思路清晰了很多。

直播课的讲解路线为：单机-集群-云部署-前后端分离调用，那本文也就按这个顺序记录一下。

## **单机模式下需要考虑的问题：**

### **1.用什么数据结构安装并记录本次发送的红包？**

比如我们要发100块，分10个包发，该用什么数据结构来记录呢？首先基于高并发下的性能考虑，肯定是使用redis来存储数据，至于用什么数据结构，老师阳哥说的是使用list结构，在发红包时用lpush存，在抢红包时用lpop取。我看见弹幕有人说无序应该用set，当时我觉得还挺有道理的，阳哥应该没看见这弹幕，所以也没说，但是后面我仔细考虑了一下，set它不能重复啊，但是红包的金额是可以重复的，所以用set显然不合适。

### **2.大家抢到的红包金额差距不能过大，拆分红包使用什么算法？**

如果抢红包活动中，100块发5个包，其中一个包96，剩余四个各1块，这样的红包分配显然是不合理的，所以得采用算法来控制红包金额的拆分范围，阳哥讲了一种在红包业务中比较通用的算法：二倍均值算法。

二倍均值算法：

假设M为总金额，N为抢红包人数，那么根据二倍均值法，每次抢到的金额 = 随机区间 （0， M / N X 2）

这个公式可以确保每个人获取的金额的平均值是相等的，不会受到先后顺序不同的影响。

> 比如说，有一个金额为100块的红包，10人分，那么：
> 100/10X2 = 20, 所以第一个人的随机范围是（0，20 )，平均可以抢到10元。
> 假设第一个人随机到10元，那么剩余金额是100-10 = 90 元。
> 90/9X2 = 20, 所以第二个人的随机范围同样是（0，20 )，平均可以抢到10元。
> 假设第二个人随机到10元，那么剩余金额是90-10 = 80 元。
> 80/8X2 = 20, 所以第三个人的随机范围同样是（0，20 )，平均可以抢到10元。
> 以此类推，每一次随机范围的均值是相等的。

代码实现如下（只考虑思路）：

```java
public static Integer[] splitRedPackageAlgorithm(int totalMoney, int redPackageNumber) {
     Integer[] redPackageNumbers = new Integer[redPackageNumber];
     //已经被抢夺的红包金额,已经被拆分塞进子红包的金额
     int useMoney = 0;

     for (int i = 0; i < redPackageNumber; i++) {
         if (i == redPackageNumber - 1) {
         	redPackageNumbers[i] = totalMoney - useMoney;
         } else {
         	//二倍均值算法，每次拆分后塞进子红包的金额 = 随机区间(0,(剩余红包金额M ÷ 未被抢的剩余红包个数N) * 2)
        	 int avgMoney = ((totalMoney - useMoney) / (redPackageNumber - i)) * 2;
        	 redPackageNumbers[i] = 1 + new Random().nextInt(avgMoney - 1);
         }
         useMoney = useMoney + redPackageNumbers[i];
     }
     return redPackageNumbers;
 }
```

### **3.高并发下怎么抢红包？**

要求做到数据一致性+高可用+不加锁，这种情况应该使用什么技术？首先类似于抢票系统中的“超卖问题"，要保证被抢金额不超过发红包的总金额，这块个人觉得阳哥讲的不是很清楚，在抢票系统中，我们常常使用锁来解决“超卖问题”，可以优化为乐观锁解决问题，但是在红包雨系统中，所有人都要去操作一个红包，所以肯定不能加锁，也就是上面说的”不加锁“，阳哥在这只说了使用lpop去抢红包，并没有解释数据一致性的实现，我的理解是在拆分红包的二分均值算法中的在最后一个包时分配”总金额-已抢金额“，这里就可以保证金额不超额，而在抢红包时只需要保证抢的包个数不大于分包总个数即可，这就和抢票系统一样了，在每次抢红包时判断剩余红包个数大于0即可。

### **4.记录红包争抢数据的功能怎么实现？**

类似于微信红包，结束后会显示每个人抢了多少，这就需要记录短期的个人抢红包数据，阳哥还提了一点就是需要记录长期的数据，比如一年中发了多少红包和抢了多少红包，这一点有点类似于微信的账单功能，怎么去记录呢？首先数据结构选择Redis的Hash结构，在每一次请红包后，使用"hset 活动id 用户id 金额"存入每个用户抢了多少红包，年度红包统计就比较简单了，将每次抢发红包数分别加起来就可以了，至于数据的持久化，也可以将数据存入mySql中。

### **5.发送的红包未抢完在24小时后回退给发送者怎么实现？**

这个功能就比较简单了，在活动结束后，计算剩余金额，设置定时任务，24小时后回退即可，可以使用redis实现也可以使用MQ实现。

这个功能和订单下单5分钟未付款就取消订单一个原理，后面有时间我也会去整理一下该功能的实现思路。

## **并发量持续加大，怎么处理？（集群）**

上面单机模式作为一个微服务，在并发量持续加大的情况下就需要做集群处理了。

在集群中需要考虑的问题：
1.如果有人盗刷，怎么配置白名单？
2.怎么做到削峰限流、服务熔断、服务降级、服务流控，最终实现分割+限流+软件负载均衡？

实现这两个问题中的功能有很多种方法，问题一可以用gateway业务网关+隔离策略解决，问题二中的限流就可以用nginx流量网关解决，但是负载均衡就需要配置集群的负载均衡策略了。

## **前后端调用架构？**

整体流程架构图如下：

![](https://cdn.jsdelivr.net/gh/twigIcer/markdown-img@main/imgs/image.png)

课程为了节省时间，前后端交互使用的是WebSocket，在正式搭建时，可以使用MQ，在活动开始前将所有发送请求的用户放入WebSocket候客室中，活动开始准时进行抢红包活动。

## **更近一步的服务扩容？**

这一步讲的就是在云上去部署组件集群、服务集群等，课程中是在阿里云服务器进行部署，个人认为这部分讲的最好，雷神一步一步操作教学，看的我挺上瘾的，收获也不少。

## **小结：**

尚硅谷的这四节直播课的含金量非常高，本文也相当于对第一节课程做了一篇笔记，现在再想想当时的那道面试题：如果要设计一个红包系统，比如春晚红包雨，在这种高并发的环境下，该怎么设计？我会先讲整体架构，然后讲怎么数据一致性+不加锁+高可用，后面再讲讲集群…唉，只能说相见恨晚啊！课程链接放下面，需要的友友可以直接点击跳转，也可以直接去B站搜索“红包雨开发架构设计”。

红包雨架构分析：https://www.bilibili.com/video/BV18k4y1P7sh/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=27972b4e93b4f51f10811f1f46f853b4

中间件与交互设计：https://www.bilibili.com/video/BV18k4y1P7sh?p=2

UI与前后端联调：https://www.bilibili.com/video/BV18k4y1P7sh?p=3&vd_source=27972b4e93b4f51f10811f1f46f853b4

云上弹性部署：https://www.bilibili.com/video/BV18k4y1P7sh?p=4&vd_source=27972b4e93b4f51f10811f1f46f853b4