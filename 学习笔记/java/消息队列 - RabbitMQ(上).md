# 消息队列 - RabbitMQ（上）

> 本文分为两篇，上篇介绍重点消息队列的概念和RabbitMQ的安装及组件介绍，下篇为RabbitMQ的入门实践。

之前写过一篇用消息队列实现下单五分钟未付款的文章，但是由于没有备份，小破站倒闭时，文章也丢失了。。吃一堑，长一智，现在本站所有文章将会在本地、github、语雀上备份，部分技术文章将会同步至CSDN和知乎，几乎不可能丢失了哈哈。

刚好最近的项目要用到消息队列，那就重新记录一下吧。

## 消息队列：

### 什么是消息队列：

> 来自ChatGPT的回答：
>
> 消息队列是一种在分布式系统中用于在不同组件之间传递消息的通信机制。它是一种异步的通信方式，允许发送者将消息发送到队列，而接收者则可以从队列中取出消息进行处理。这种解耦的方式使得消息生产者和消费者之间不直接依赖彼此，从而实现了系统的松耦合。

消息队列（MQ）就是存储、传输消息的队列。队列：先进先出的数据结构，消息：某种数据结构，比如字符串、对象、二进制数据、json 等等，消息队列就是一种专门处理消息的队列。

![image-20240219123141574](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219123141574.png)

### 常用术语：

生产者：Producer，类比为快递员，发送消息的人（客户端）

消费者：Consumer，类比为取快递的人，接受读取消息的人（客户端）

消息：Message，类比为快递，就是生产者要传输给消费者的数据

消息队列：Queue，类比为快递驿站，处理消息的数据结构

### 消息队列的特点：

1. **异步通信：** 发送者和接收者是异步进行的，发送者不需要等待接收者处理完消息，可以继续执行其他任务。
2. **解耦：** 生产者和消费者之间通过消息队列进行通信，彼此不直接依赖。这使得系统中的各个组件能够独立演化，更容易扩展和维护。
3. **消息持久化：** 消息通常会被持久化到消息队列中，确保在发送和接收之间的任何时刻，消息都是可靠的。
4. **顺序性：** 消息队列通常能够保持消息的顺序性，确保消息按照发送的顺序被接收。
5. **消息确认：** 确认机制确保消息被正确接收和处理，防止消息的丢失。
6. **伸缩性：** 可以通过增加消息队列的节点或者使用分布式消息队列来实现系统的伸缩性。

### 常见的消息队列及对比：

常见的MQ:

1. **ActiveMQ：**Apache ActiveMQ 是一个开源消息代理，支持多种协议，通常用于构建分布式系统的 Java 环境。
2. **RabbitMQ：**RabbitMQ 是一个开源的消息代理，支持 AMQP 等协议，为各种消息场景提供灵活性和可靠性。
3. **Kafka：**Kafka 是一个分布式流式处理平台，以其高吞吐量、容错和实时数据流功能而闻名，通常用于构建实时数据管道。
4. **RocketMQ：**Apache RocketMQ 是一个分布式消息流式处理平台，专为高吞吐、有序消息投递和高可用而设计，适用于电商、金融等场景。
5. **Pulsar：**Apache Pulsar 是一个分布式消息传递和事件流平台，专为可扩展性、多租户和持久性而构建，通常用于云原生架构，以实现低延迟和可靠的消息传递。

各MQ对比：

![](https://articleimgs.xiaoshuzhi.xyz/imgs/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-19%20112037.png)

### 消息队列的优点 or 作用：

1. **异步通信：** 发送者将消息发送到队列后即可继续执行其他任务，而无需等待接收者处理消息。

2. **应用解耦：**可以连接各个不同语言、框架开发的系统，让这些系统能够灵活传输读取数据。

   1一个系统挂了，不影响另一个系统。

   2系统挂了并恢复后，仍然可以取出消息，继续执行业务逻辑。

   3只要发送消息到队列，就可以立刻返回，不用同步调用所有系统，性能更高。

   比如：

   订单系统库存系统发货系统消息队列“我下订单了” 的消息取消息、扣库存取消息、执行发货总耗时 2 ms，就可以告诉用户下单成功2ms。

3. **流量控制和削峰填谷：** 消息队列可以缓冲突发的消息，从而平滑系统的流量波动，避免突发性的高流量对系统造成影响，同时也可以缓解系统压力。

   先把用户的请求放到消息队列中，消费者（实际执行操作的应用）可以按照自己的需求，慢慢去取。

   原本：12 点时来了 10 万个请求，原本情况下，10万个请求都在系统内部立刻处理，很快系统压力过大就宕机了。

   现在：把这 10万个请求放到消息队列中，处理系统以自己的恒定速率（比如每秒 1 个）慢慢执行，从而保护系统、稳定处理。

4. **提高系统可用性和可靠性：** 通过将消息持久化到队列中，即使在系统组件之间发生故障或网络中断时，消息也不会丢失。这提高了系统的可用性和可靠性。

5. **可扩展性：**可以根据需求，随时增加（或减少）节点，继续保持稳定的服务。

6. **支持多种通信模式：** 消息队列支持多种通信模式，包括点对点通信、发布订阅模式等，从而满足不同场景下的通信需求。

   比如发布订阅：

   大的核心系统始终往一个地方（消息队列）去发消息，其他的系统都去订阅这个消息队列（读取这个消息队列中的消息）:

   消息队列微信王者荣耀吃鸡100 个系统...订阅QQ 做一个调整，要让其他系统知道，比如公告消息新的小项目QQ(非常大的核心系统）发布

### 消息队列的使用场景：

结合以上优点来分析，消息队列适用于：

1. 耗时的场景（异步）

2. 高并发场景（异步、削峰填谷）

3. 分布式系统协作（尤其是跨团队、跨业务协作，应用解耦）

4. 强稳定性的场景（比如金融业务，持久化、可靠性、削峰填谷）

消息队列常见的应用场景有：

1. **日志处理：** 将系统产生的日志信息异步发送到消息队列，以便后续的处理、分析和存储，帮助监控系统状态和进行故障排查。
2. **解耦和流程控制：** 在复杂系统中，通过消息队列可以实现不同组件之间的解耦，同时通过消息的流程控制来确保数据的有序处理。
3. **削峰填谷：** 在高并发情况下，通过消息队列来平滑处理系统的请求流量，防止突发的高流量对系统造成压力。
4. **订单处理系统：** 在电商系统中，通过消息队列处理订单的创建、支付、发货等流程，确保订单处理的可靠性和有序性。
5. **通知和推送服务：** 通过消息队列来实现通知和推送服务，例如将消息推送到用户设备，处理用户订阅的信息等。
6. **数据同步：** 在分布式数据库或多个数据存储系统之间，通过消息队列同步数据，确保数据一致性和可靠性。
7. **实时数据处理：** 在大数据场景中，通过消息队列传递实时数据流，支持实时数据处理和分析。

### 使用消息队列需要考虑的问题：

1. **复杂性：** 引入消息队列会增加系统的复杂性，需要额外的配置、管理和维护，可能需要专门的技术人员进行管理。
2. **一致性问题：** 在消息队列中，消息的消费可能失败或者重复消费，这可能导致数据的一致性问题，需要在设计和实现时考虑如何处理这些情况。
3. **性能开销：** 使用消息队列会带来一定的性能开销，包括消息序列化、网络传输、存储等方面的开销，需要权衡性能和可靠性之间的关系。
4. **消息丢失风险：** 尽管消息队列通常会将消息持久化到存储中，但在某些情况下仍然可能发生消息丢失的风险，例如硬件故障、网络中断等。
5. **消息顺序问题：** 在分布式环境中，消息队列可能无法保证消息的严格顺序传递，特别是在水平扩展和高可用性配置下，可能会出现消息乱序的情况。
6. **技术选择困难：** 在选择消息队列时，需要考虑诸多因素，包括性能、可靠性、功能特性、成本等，可能需要进行一定的评估和比较。
7. **数据安全性：** 在消息队列中传输的消息可能包含敏感信息，需要采取相应的安全措施来保护数据的安全性，例如加密、身份认证等。

## RabbitMQ：

官网：[RabbitMQ: easy to use, flexible messaging and streaming — RabbitMQ](https://www.rabbitmq.com/)

### 为什么选用RabbitMQ:

在实际业务中，选用什么消息队列需要根据业务量和对数据安全性来分析。

这里选用RabbitMQ的原因是：综合性能较好，且简单易学，生态好，支持不同语言客户端，学习性价比较高。

### RabbitMQ的下载安装：

> 本次演示windows的安装方法！！

下载地址：[Downloading and Installing RabbitMQ — RabbitMQ](https://www.rabbitmq.com/download.html)

1. 选择windows Installer:

![image-20240219134800148](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219134800148.png)

2. 如果电脑上有Chocolatey包管理器（类似于npm），可以直接输入"choco install rabbitmq"安装：

![image-20240219135513346](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219135513346.png)

3. 如果没有Chocolatey包管理器，需要先安装erlang（一种编程语言，性能非常高，rabbitmq用erlang实现）：

   地址：[Otp 25.3.2 - Erlang/OTP](https://www.erlang.org/patches/otp-25.3.2)

   ![](https://articleimgs.xiaoshuzhi.xyz/imgs/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-02-19%20140208.png)

   选择windows installer下载：

   ![image-20240219140704807](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219140704807.png)

   erlang下载完成傻瓜式安装，注意安装路径不要有中文和空格，最好不要装C盘。

   **安装完成后最好重启一下电脑！！**

4. 下载rabbitMQ，选择windows installer直接下载：

![image-20240219135700656](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219135700656.png)

​		下载完成后，同样傻瓜式安装即可，注意安装路径不要有中文和空格，最好不要装C盘。

5. 安装完成后，按win + r 键，输入 services.msc 查看服务状态，如果RabbitMQ未启动将其启动，如果显示正在运行则启动成功：

   ![image-20240219142359374](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219142359374.png)

6. 安装管理面板，plugin - management：

   1)地址：[Management Plugin — RabbitMQ](https://www.rabbitmq.com/management.html)

   2)复制命令：

   ```bash
   rabbitmq-plugins.bat enable rabbitmq_management
   ```

   3)打开rabbitMQ的安装位置的sbin/目录，打开cmd，输入上面的命令安装管理面板：

   ![image-20240219143324039](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219143324039.png)

   4)在浏览器输入：localhost:15672，看到登录页面即表示rabbitMQ安装完成，**显示拒绝访问时，重启电脑即可**（本来应该在安装完erlang后就重启）：
   
   ![image-20240219144814730](https://articleimgs.xiaoshuzhi.xyz/imgs/image-20240219144814730.png)

7. 登录：

   rabbitmq默认分配了管理员账号密码，账号：guest，密码：guest，登录即可。

   如果想要在远程服务器安装访问 rabbitmq 管理面板，你要自己创建一个管理员账号，不能用默认的 guest，否则会被拦截（官方出于安全考虑）。

   **如果被拦截，可以自己创建管理员用户：**

   参考文档的 Adding a User：https://www.rabbitmq.com/access-control.html

### rabbitMQ的组件：

rabbitMQ遵循AMQP协议，所以包含的组件即AMQP规定的组件：

官网：[AMQP 0-9-1 Model Explained — RabbitMQ](https://www.rabbitmq.com/tutorials/amqp-concepts.html)

**AMQP**（Advanced Message Queuing Protocol）是一种**开放式、标准化的网络通信协议**，用于在分布式系统中进行消息通信和数据交换。它是一种面向消息的协议，支持完整的消息传递模型，包括消息路由、发布/订阅模式、可靠性传输、流量控制等。AMQP 协议规范包含以下主要组件：

1. **Exchange（交换机）：**Exchange 是消息的中转站，它接收来自生产者的消息，并将它们路由到一个或多个队列中。Exchange 根据规则（Binding）决定将消息发送到哪个队列中。
2. **Queue（队列）：**Queue 是消息的缓存区，它存储 Exchange 发送过来的消息，等待被消费者消费。Queue 可以绑定到一个或多个 Exchange 上。
3. **Binding（绑定）：**Binding 定义了 Exchange 与 Queue 之间的关系，它规定了消息应该如何路由到对应的队列中。Binding 是通过 Routing Key 进行匹配的。
4. **Connection （连接）：**Connection 是生产者和消费者与消息中间件之间的网络连接，它负责传输消息，并管理与消息中间件的通信会话。
5. **Channel （通道）：**Channel 是在 Connection 上建立的逻辑通道，它负责在单个连接上执行 AMQP 命令，并实现了流量控制和信道复用等功能，可以有效地减少网络开销。
6. **Message（消息）：**Message 是传输的数据单元，它由 Header、Body 和 Properties 组成。Header 包含一些元数据信息，Properties 包含一些可选的属性，Body 包含消息体。
7. **Virtual Host（虚拟主机）：**Virtual Host 是 AMQP 的逻辑概念，它将 Exchange、Queue 和 Binding 进行分组和隔离，使得不同的应用可以在同一个消息中间件实例中独立地进行消息通信。

注意：在 AMQP 中，路由是通过 Exchange 和 Binding 来实现的：

在 AMQP 中，Exchange 根据消息的 Routing Key 将消息路由到一个或多个与之绑定的 Queue。Binding 定义了 Exchange 与 Queue 之间的关系，规定了消息应该如何路由到对应的队列中。当生产者发送一条消息时，它将消息发送到 Exchange，Exchange 根据 Binding 规则将消息路由到一个或多个队列中，然后消费者从队列中接收并处理消息。



#### RabbitMQ的快速入门案例请看下篇！！！！
